<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nexus Cashier</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        
        .table-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        .occupied { background-color: #ffcccc; border-color: red; color: darkred; }
        .free { background-color: #ccffcc; border-color: green; color: darkgreen; }

        /* Modal for Bill */
        #bill-modal {
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 300px;
        }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total-row { font-weight: bold; border-top: 1px dashed black; margin-top: 10px; padding-top: 5px; }
        
        button { padding: 10px; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-print { background: #333; color: white; border: none; }
        .btn-settle { background: #4CAF50; color: white; border: none; }
        .btn-close { background: #ddd; border: none; }
    </style>
</head>
<body>

    <h1>üí∞ CASHIER DASHBOARD</h1>
    <div id="table-grid" class="grid">Loading...</div>

    <div id="bill-modal">
        <h2 style="text-align:center">RECEIPT</h2>
        <div id="bill-items"></div>
        <div class="bill-row total-row"><span>Total:</span> <span id="bill-total">0.00</span></div>
        
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è PRINT BILL</button>
        <button class="btn-settle" onclick="settleBill()">‚úÖ PAID & CLEAR TABLE</button>
        <button class="btn-close" onclick="closeModal()">Close</button>
    </div>

    <script>
        const RESTAURANT_ID = "aa5e8652-7e8a-4a19-8497-54d56221ecee"; 
        const API_URL = "http://127.0.0.1:8000/api";
        let currentTableId = null;

        async function loadTables() {
            const res = await fetch(`${API_URL}/tables/${RESTAURANT_ID}/`);
            const tables = await res.json();
            
            const grid = document.getElementById('table-grid');
            grid.innerHTML = "";
            
            tables.forEach(t => {
                const div = document.createElement('div');
                div.className = `table-card ${t.is_occupied ? 'occupied' : 'free'}`;
                div.innerText = t.name + (t.is_occupied ? "\n(Occupied)" : "\n(Free)");
                
                if(t.is_occupied) {
                    div.onclick = () => showBill(t.id);
                }
                grid.appendChild(div);
            });
        }

        async function showBill(tableId) {
            currentTableId = tableId;
            const res = await fetch(`${API_URL}/bill/${tableId}/`);
            if(res.status !== 200) { alert("Error fetching bill"); return; }
            
            const data = await res.json();
            
            // Render Items
            let html = "";
            data.items.forEach(item => {
                html += `<div class="bill-row">
                    <span>${item.quantity} x Item ${item.menu_item}</span>
                    <span>${item.price_at_time_of_order * item.quantity}</span>
                </div>`;
            });
            html += `<div class="bill-row"><span>Tax (5%):</span><span>${data.tax.toFixed(2)}</span></div>`;
            
            document.getElementById('bill-items').innerHTML = html;
            document.getElementById('bill-total').innerText = "‚Çπ" + data.grand_total.toFixed(2);
            document.getElementById('bill-modal').style.display = 'block';
        }

        async function settleBill() {
            if(!confirm("Confirm Payment Received?")) return;
            await fetch(`${API_URL}/settle/${currentTableId}/`, { method: 'POST' });
            closeModal();
            loadTables(); // Refresh grid
        }

        function closeModal() {
            document.getElementById('bill-modal').style.display = 'none';
        }

        loadTables();
        setInterval(loadTables, 5000); // Auto refresh
    </script>

</body>
</html>